<div class="w-full max-w-6xl flex flex-col h-[90vh]">
    <div class="flex items-center justify-between p-6 border-b flex-shrink-0">
        <div>
            <h2 class="text-2xl font-semibold">Customer Transactions</h2>
            <p class="text-gray-600 mt-1">{{ customer.name }} - {{ customer.email }}</p>
        </div>
        <button mat-icon-button (click)="close()">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6">
        <!-- Filter Form -->
        <form [formGroup]="filterForm" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <mat-form-field appearance="outline">
                    <mat-label>From Date</mat-label>
                    <input matInput [matDatepicker]="fromPicker" formControlName="from_date">
                    <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
                    <mat-datepicker #fromPicker [restoreFocus]="false"></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>To Date</mat-label>
                    <input matInput [matDatepicker]="toPicker" formControlName="to_date">
                    <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
                    <mat-datepicker #toPicker [restoreFocus]="false"></mat-datepicker>
                </mat-form-field>

                <div class="flex items-center gap-2">
                    <button mat-flat-button type="button" (click)="onFilter()" class="bg-primary text-white">
                        <mat-icon class="mr-1">filter_list</mat-icon>
                        Filter
                    </button>
                    <button mat-stroked-button type="button" (click)="onResetFilters()" [disabled]="!hasActiveFilters">
                        Reset
                    </button>
                </div>
            </div>
        </form>

        <!-- Transactions Table -->
        <div class="overflow-x-auto">
            @if (loading) {
                <div class="flex items-center justify-center h-64">
                    <mat-spinner diameter="40"></mat-spinner>
                </div>
            } @else if (transactions.length === 0) {
                <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                    <mat-icon class="text-6xl mb-4">receipt_long</mat-icon>
                    <p class="text-xl font-medium">No transactions found</p>
                    <p class="text-sm mt-2">Try adjusting your filters</p>
                </div>
            } @else {
                <table mat-table [dataSource]="transactions" class="w-full">
                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                        <th mat-header-cell *matHeaderCellDef>ID</th>
                        <td mat-cell *matCellDef="let transaction">
                            {{ transaction.id }}
                        </td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="type">
                        <th mat-header-cell *matHeaderCellDef>Type</th>
                        <td mat-cell *matCellDef="let transaction">
                            <span class="transaction-type-label" 
                                  [ngClass]="transaction.type === '+' ? 'positive' : 'negative'">
                                {{ transaction.type_label }}
                            </span>
                        </td>
                    </ng-container>

                    <!-- Amount Column -->
                    <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Amount</th>
                        <td mat-cell *matCellDef="let transaction">
                            <span [class.text-green-600]="transaction.type === '+'"
                                  [class.text-red-600]="transaction.type === '-'">
                                {{ transaction.amount }} EGP
                            </span>
                        </td>
                    </ng-container>

                    <!-- Description Column -->
                    <ng-container matColumnDef="description">
                        <th mat-header-cell *matHeaderCellDef>Description</th>
                        <td mat-cell *matCellDef="let transaction">
                            {{ transaction.description || '-' }}
                        </td>
                    </ng-container>

                    <!-- Created At Column -->
                    <ng-container matColumnDef="created_at">
                        <th mat-header-cell *matHeaderCellDef>Date & Time</th>
                        <td mat-cell *matCellDef="let transaction">
                            {{ formatDateTime(transaction.created_at) }}
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <!-- Pagination -->
                @if (transactionsMeta?.total > 0) {
                    <div class="w-full flex justify-center p-4 border-t">
                        <app-pagination
                            [meta]="transactionsMeta"
                            [currentPage]="params.page"
                            (pageChange)="pageChanger($event)"
                            (pageSizeChange)="onPageSizeChange($event)"
                            [per_page]="params.per_page">
                        </app-pagination>
                    </div>
                }
            }
        </div>
    </div>

    <div class="flex justify-end p-6 border-t flex-shrink-0">
        <button mat-button (click)="close()">Close</button>
    </div>
</div>